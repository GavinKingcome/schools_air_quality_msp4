{% extends 'base.html' %} {% load static %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'maps/css/map.css' %}" />
<!-- Leaflet MarkerCluster CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>

<style>
  /* Ensure popups appear above all controls */
  .leaflet-popup {
    z-index: 10000 !important;
  }

  .leaflet-popup-pane {
    z-index: 10000 !important;
  }

  .leaflet-popup-content-wrapper {
    z-index: 10000 !important;
  }

  .leaflet-popup-tip-container {
    z-index: 10000 !important;
  }

  /* Lower the z-index of controls to ensure they stay below popups */
  .leaflet-control-zoom {
    z-index: 999 !important;
  }

  .map-search-container {
    z-index: 1000 !important;
  }

  .sensor-toggle-control {
    z-index: 1000 !important;
  }

  /* Custom cluster styling for Southwark (blue) */
  .marker-cluster-southwark {
    background-color: rgba(41, 128, 185, 0.6);
  }
  .marker-cluster-southwark div {
    background-color: rgba(41, 128, 185, 0.8);
    color: white;
    font-weight: bold;
  }

  /* Custom cluster styling for Lambeth (green) */
  .marker-cluster-lambeth {
    background-color: rgba(46, 204, 113, 0.6);
  }
  .marker-cluster-lambeth div {
    background-color: rgba(46, 204, 113, 0.8);
    color: white;
    font-weight: bold;
  }
</style>

{% endblock %} {% block content %}
<div id="map">
  <div
    class="map-search-container"
    style="position: absolute; top: 20px; right: 20px; width: 300px"
  >
    <div style="position: relative">
      <input
        type="text"
        id="schoolSearch"
        placeholder="Search schools..."
        style="
          width: 100%;
          padding: 12px 40px 12px 15px;
          font-size: 0.95rem;
          border: none;
          border-radius: 8px;
          background: white;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        "
      />
      <button
        id="clearSearch"
        style="
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          background: none;
          border: none;
          font-size: 1.2rem;
          color: #999;
          cursor: pointer;
          padding: 5px;
          display: none;
          line-height: 1;
        "
      >
        √ó
      </button>
    </div>
    <div
      class="search-results"
      id="searchResults"
      style="
        background: white;
        margin-top: 8px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-height: 400px;
        overflow-y: auto;
        display: none;
      "
    ></div>
  </div>

  <!-- Map Legend -->
  <div class="map-legend">
    <h4>Borough</h4>
    <div class="legend-item">
      <img
        src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png"
        alt="Southwark"
      />
      <span>Southwark</span>
    </div>
    <div class="legend-item">
      <img
        src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png"
        alt="Lambeth"
      />
      <span>Lambeth</span>
    </div>
  </div>

  <!-- Sensor Legend -->
  <div class="sensor-legend">
    <h4>Air Quality Sensors</h4>
    <div class="legend-item">
      <img
        src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png"
        alt="LAQN"
      />
      <span>LAQN (Reference-grade)</span>
    </div>
    <div class="legend-item">
      <img
        src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png"
        alt="Breathe London"
      />
      <span>Breathe London (Calibrated)</span>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- Leaflet MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    // Initialize the map
    const map = L.map('map').setView([51.4893, -0.0927], 12);

    // Define custom marker icons for each borough
    const southwarkIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    const lambethIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    const laqnSensorIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [20, 33],  // Slightly smaller than schools
        iconAnchor: [10, 33],
        popupAnchor: [0, -30],
        shadowSize: [33, 33]
    });
    const breatheSensorIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [20, 33],
        iconAnchor: [10, 33],
        popupAnchor: [0, -30],
        shadowSize: [33, 33]
    });

    // Add CartoDB Positron tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        maxZoom: 19
    }).addTo(map);

  // Get schools data from Django
    const schools = {{ schools_json|safe }};
    const sensors = {{ sensors_json|safe }};

  // Store markers for search functionality
    const markersMap = new Map();
  // Create sensor layer group (hidden by default)
    const sensorLayer = L.layerGroup();

  // Create marker cluster groups for each borough
  const southwarkCluster = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      maxClusterRadius: 50,
      iconCreateFunction: function(cluster) {
          return L.divIcon({
              html: '<div><span>' + cluster.getChildCount() + '</span></div>',
              className: 'marker-cluster marker-cluster-southwark',
              iconSize: L.point(40, 40)
          });
      }
  });

  const lambethCluster = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      maxClusterRadius: 50,
      iconCreateFunction: function(cluster) {
          return L.divIcon({
              html: '<div><span>' + cluster.getChildCount() + '</span></div>',
              className: 'marker-cluster marker-cluster-lambeth',
              iconSize: L.point(40, 40)
          });
      }
  });

  // Helper function to create pollution display with guidelines
    const createPollutantDisplay = (name, value, whoLimit, euLimit, ukLimit) => {
      if (value === null) return '';

      const meetsWHO = value <= whoLimit;
      const meetsEU = value <= euLimit;
      const meetsUK = value <= ukLimit;

      return `
          <div style="margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 6px;">
              <div style="font-weight: 600; margin-bottom: 8px;">${name}: ${value.toFixed(1)} ¬µg/m¬≥</div>
              <div style="font-size: 0.85em; line-height: 1.6;">
                  <div style="color: ${meetsWHO ? '#28a745' : '#dc3545'};">
                      ${meetsWHO ? '‚úì' : '‚úó'} ${meetsWHO ? 'Meets' : 'Exceeds'} WHO guideline (${whoLimit})
                  </div>
                  <div style="color: ${meetsEU ? '#28a745' : '#dc3545'};">
                      ${meetsEU ? '‚úì' : '‚úó'} ${meetsEU ? 'Meets' : 'Exceeds'} EU 2024 standard (${euLimit})
                  </div>
                  <div style="color: ${meetsUK ? '#28a745' : '#dc3545'};">
                      ${meetsUK ? '‚úì' : '‚úó'} ${meetsUK ? 'Meets' : 'Exceeds'} UK legal limit (${ukLimit})
                  </div>
              </div>
              <div style="margin-top: 8px; height: 8px; background: #e9ecef; border-radius: 4px; position: relative;">
                  <div style="position: absolute; left: ${(whoLimit/ukLimit*100)}%; top: 0; bottom: 0; width: 1px; background: #28a745;" title="WHO"></div>
                  <div style="position: absolute; left: ${(euLimit/ukLimit*100)}%; top: 0; bottom: 0; width: 1px; background: #ffc107;" title="EU"></div>
                  <div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${Math.min(value/ukLimit*100, 100)}%; background: ${meetsEU ? '#28a745' : meetsUK ? '#ffc107' : '#dc3545'}; border-radius: 4px;"></div>
              </div>
              <div style="font-size: 0.75em; color: #6c757d; margin-top: 4px; display: flex; justify-content: space-between;">
                  <span>WHO (${whoLimit})</span>
                  <span>EU (${euLimit})</span>
                  <span>UK (${ukLimit})</span>
              </div>
          </div>
      `;
  };

  // Add markers for each school with borough-specific colors
  schools.forEach(school => {
      // Choose icon based on borough field
      const icon = school.borough && school.borough.toLowerCase().includes('southwark') ? southwarkIcon : lambethIcon;

      const marker = L.marker([school.latitude, school.longitude], { icon: icon });

      const popupContent = `
          <div style="min-width: 300px; max-width: 400px;">
              <h3 style="margin-top: 0;">${school.name}</h3>
              <p><strong>Type:</strong> ${school.school_type}</p>
              <p><strong>Borough:</strong> ${school.borough}</p>
              <p><strong>Address:</strong> ${school.address}</p>
              <p><strong>Postcode:</strong> ${school.postcode}</p>
              ${school.student_count ? `<p><strong>Students:</strong> ${school.student_count}</p>` : ''}

              ${school.data_source === 'DIRECT' ? `
              <p><strong>Data Source:</strong> Direct sensor reading</p>
              <p style="font-size: 0.85em; color: #28a745;">üìç Sensor ${school.direct_sensor} (genuinely local)</p>
              ` : school.data_source === 'ADJUSTED' ? `
              <p><strong>Data Source:</strong> LAEI √ó sensor adjustment</p>
              <p style="font-size: 0.85em; color: #ffc107;">üìä Reference sensor ${school.reference_sensor}</p>
              ` : `
              <p><strong>Data Source:</strong> LAEI modeled baseline</p>
              <p style="font-size: 0.85em; color: #6c757d;">No nearby sensors for real-time data</p>
            `}


              ${school.laei_data_available ? `
                  <hr style="margin: 15px 0; border: none; border-top: 1px solid #dee2e6;">
                  <h4 style="margin: 10px 0;">Modeled Annual Averages</h4>
                  ${createPollutantDisplay('NO‚ÇÇ', school.no2_2022, 10, 20, 40)}
                  ${createPollutantDisplay('PM2.5', school.pm25_2022, 5, 10, 25)}
                  ${createPollutantDisplay('PM10', school.pm10_mean_2022, 15, 20, 40)}
              ` : '<p style="color: #6c757d; font-style: italic; margin-top: 10px;">No air quality data available</p>'}
          </div>
      `;

      marker.bindPopup(popupContent, {
          maxWidth: 450,
          autoPan: true,
          autoPanPaddings: [50,50]
      });
      markersMap.set(school.id, { marker, school });

      // Add marker to appropriate cluster
      if (school.borough === 'Southwark') {
          southwarkCluster.addLayer(marker);
      } else {
          lambethCluster.addLayer(marker);
      }
  });

  // Add clusters to map
  map.addLayer(southwarkCluster);
  map.addLayer(lambethCluster);

  // Add sensor markers to layer (not to map yet)
  sensors.forEach(sensor => {
      const icon = sensor.network === 'LAQN' ? laqnSensorIcon : breatheSensorIcon;
      const marker = L.marker([sensor.latitude, sensor.longitude], { icon: icon });

      const popupContent = `
          <div style="min-width: 250px;">
              <h3 style="margin-top: 0;">${sensor.site_code}</h3>
              <p><strong>Network:</strong> ${sensor.network}</p>
              <p><strong>Type:</strong> ${sensor.site_type.replace('_', ' ')}</p>
              <p><strong>Reference Grade:</strong> ${sensor.is_reference_grade ? 'Yes (LAQN)' : 'No (Low-cost calibrated)'}</p>
              <p><strong>Urban Background:</strong> ${sensor.is_urban_background ? 'Yes' : 'No'}</p>
          </div>
      `;

      marker.bindPopup(popupContent);
      sensorLayer.addLayer(marker);
  });

  // Add sensor toggle control
  const sensorToggleControl = L.control({ position: 'topleft' });
  sensorToggleControl.onAdd = function(map) {
      const div = L.DomUtil.create('div', 'sensor-toggle-control');
      div.style.cssText = 'background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 10px;';
      div.innerHTML = `
          <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.9rem;">
              <input type="checkbox" id="sensorToggle" style="margin-right: 8px; cursor: pointer;">
              <span>Show Sensors</span>
          </label>
      `;

      L.DomEvent.disableClickPropagation(div);
      return div;
  };
  sensorToggleControl.addTo(map);

  // Handle toggle
  document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
          const toggle = document.getElementById('sensorToggle');
          if (toggle) {
              toggle.addEventListener('change', function() {
                  if (this.checked) {
                      map.addLayer(sensorLayer);
                  } else {
                      map.removeLayer(sensorLayer);
                  }
              });
          }
      }, 100);
  });

  // Reset map view when popup closes
  map.on('popupclose', function() {
      if (window.originalMapBounds) {
          map.fitBounds(window.originalMapBounds, window.originalMapZoomOptions);
      }
      // Show legends and controls again on mobile
      if (window.innerWidth <= 768) {
          document.querySelector('.map-legend').style.display = 'block';
          document.querySelector('.sensor-legend').style.display = 'block';
          document.querySelector('.map-search-container').style.display = 'block';
          const toggleControl = document.querySelector('.sensor-toggle-control');
          if (toggleControl) toggleControl.style.display = 'block';
      }
  });

  // Hide legends and controls on mobile when popup opens (so popup appears on top)
  map.on('popupopen', function() {
      if (window.innerWidth <= 768) {
          document.querySelector('.map-legend').style.display = 'none';
          document.querySelector('.sensor-legend').style.display = 'none';
          document.querySelector('.map-search-container').style.display = 'none';
          const toggleControl = document.querySelector('.sensor-toggle-control');
          if (toggleControl) toggleControl.style.display = 'none';
      }
  });

    // Auto-fit map to show all markers

    // Auto-fit map to show all markers
    if (schools.length > 0) {
        const group = L.featureGroup(schools.map(s => L.marker([s.latitude, s.longitude])));
        const originalBounds = group.getBounds().pad(0.05);
        map.fitBounds(originalBounds, { maxZoom: 13 });

        // Store original bounds for reset
        window.originalMapBounds = originalBounds;
        window.originalMapZoomOptions = { maxZoom: 13 };

    }

    // Search functionality with dropdown
    const searchInput = document.getElementById('schoolSearch');
    const searchResults = document.getElementById('searchResults');
    const clearButton = document.getElementById('clearSearch');

    // Disable map interactions when mouse is over search container
    const searchContainer = document.querySelector('.map-search-container');
    L.DomEvent.disableClickPropagation(searchContainer);
    L.DomEvent.disableScrollPropagation(searchContainer);

    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        const sensorToggle = document.querySelector('.sensor-toggle-control');

        // Show/hide clear button
        clearButton.style.display = this.value ? 'block' : 'none';

        if (searchTerm === '') {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            // Show sensor toggle again when search cleared
            if (sensorToggle) sensorToggle.style.display = 'block';
            // Reset all markers to full opacity
            markersMap.forEach(({marker}) => marker.setOpacity(1));
            return;
        }

        // Filter schools
        const matches = schools.filter(school =>
            school.name.toLowerCase().includes(searchTerm) ||
            school.postcode.toLowerCase().includes(searchTerm) ||
            school.city.toLowerCase().includes(searchTerm)
        );

        // Show results in dropdown
        if (matches.length > 0) {
            searchResults.innerHTML = matches.map(school => `
                <div class="search-result-item" data-school-id="${school.id}" style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${school.name}</div>
                    <div style="font-size: 0.85rem; color: #666;">${school.postcode} ‚Ä¢ ${school.city}</div>
                </div>
            `).join('');
            searchResults.style.display = 'block';
            // Hide sensor toggle when dropdown shows
            if (sensorToggle) sensorToggle.style.display = 'none';

            // Add click handlers to results
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = '#f8f9fa';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                });
                item.addEventListener('click', function() {
                    const schoolId = parseInt(this.dataset.schoolId);
                    const {marker, school} = markersMap.get(schoolId);

                    // Zoom to marker and open popup
                    map.setView([school.latitude, school.longitude], 16);
                    marker.openPopup();

                    // Clear search
                    searchInput.value = school.name;
                    searchResults.style.display = 'none';
                    clearButton.style.display = 'block';
                    
                    // Show sensor toggle again when dropdown closes
                    const sensorToggle = document.querySelector('.sensor-toggle-control');
                    if (sensorToggle) sensorToggle.style.display = 'block';
                });
            });
        } else {
            searchResults.innerHTML = '<div style="padding: 20px 15px; text-align: center; color: #999; font-size: 0.9rem;">No schools found</div>';
            searchResults.style.display = 'block';
        }

        // Dim non-matching markers
        markersMap.forEach(({marker, school}) => {
            const matches = school.name.toLowerCase().includes(searchTerm) ||
                          school.postcode.toLowerCase().includes(searchTerm) ||
                          school.city.toLowerCase().includes(searchTerm);
            marker.setOpacity(matches ? 1 : 0.2);
        });
    });

    // Clear search when clicking the X button
    clearButton.addEventListener('click', function(e) {
        e.stopPropagation();
        searchInput.value = '';
        searchResults.style.display = 'none';
        clearButton.style.display = 'none';

        // Show sensor toggle again
        const sensorToggle = document.querySelector('.sensor-toggle-control');
        if (sensorToggle) sensorToggle.style.display = 'block';

        // Reset all markers to full opacity
        markersMap.forEach(({marker}) => marker.setOpacity(1));

         // Zoom back out to show all schools
        if (window.originalMapBounds) {
            map.fitBounds(window.originalMapBounds, window.originalMapZoomOptions);
        }
    });

    // Hover effect for clear button
    clearButton.addEventListener('mouseenter', function() {
        this.style.color = '#333';
    });
    clearButton.addEventListener('mouseleave', function() {
        this.style.color = '#999';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.map-search-container')) {
            searchResults.style.display = 'none';
        }
    });
</script>
{% endblock %}
